<h5>Euismod Aenean Ornare Malesuada Inceptos</h5>
<pre class="prettyprint linenums"><code>
<span class="pln">class </span><span class="kwd">BinaryTree</span>
  <span class="atn">attr_accessor</span> <span class="atv">:value, :right_branch, :left_branch</span>

  <span class="pln">def</span> <span class="typ">initialize(value)</span>
    <span class="pln">@value = value
    @left_branch = nil
    @right_branch = nil
  end</span>
  
  def insert(value)
    if value > @value
      @right_branch ? @right_branch.insert(value) : @right_branch = BinaryTree.new(value)
    elsif value < @value
      @left_branch ? @left_branch.insert(value) : @left_branch = BinaryTree.new(value)
    else
       'world ends'
    end
  end
<span class="kwd">end</span></code></pre>

<!-- Inline images for post-content -->
<img class="inline-image left-align" src=""/>
<img class="inline-image right-align" src=""/>






<!-- 
——————————————————————————————————————————
      AMAZON SIGNKEY POST
——————————————————————————————————————————
 -->
<p class='lead'>In order to upload files to an AWS s3 server, you need the proper credentials and you have to pass these credentials into a multipart form with your file/data. Creating the credentials is not trivial.</p>
<p class="lead">We make this a class method so when the endpoint receives the GET request, we can call <code class="inline">Amazon.get_s3_upload_key</code> and render the returned hash into json by the controller. The hash generated will consist of 4 objects:</p>
<ol>
  <li>Your access key (obtained through AWS),</li>
  <li>A secure, random key that will be the url of the s3 object,</li>
  <li>The policy: a stringified hash Base64 encoded, and</li>
  <li>The signature: the policy hashed with your AWS secret key, then Base64 encoded.</li>
</ol>

<p class="lead">Obtaining <strong>access keys and secrets</strong> is a trivial process. You'll need to create an account with <a href="http://aws.amazon.com/">Amazon Web Services</a>. Once you have registered the next step is to set up an IAM identity. Your access keys and secrets are assigned to an IAM identity.</p>

<p class="lead">The <strong>key</strong> is generated by ruby's built in secure random number generator interface. The result will be appended onto the bucket url and ultimately form the url for the s3 object.</p>
<pre><code>
  <span class="str">SecureRandom.uuid</span> <span class="com">#=> 2d931510-d99f-494a-8c67-87feb05e1594</span>
</code></pre>

<p class="lead">The <strong>policy</strong> is Base64 encoded and must consist (at-least) of the following elements:</p>

<h3 class="lead">Expiration (Time Object).</h3>

<p> Tells amazon how long this policy will be valid.</p>
<pre><code>
  <span class="sym">30</span><span class="plain">.minutes.from_now.utc.strftime(</span><span class="str">'%Y-%m-%dT%H:%M:%S.000Z</span><span class="plain">)</span> <span class="com">#=> 2014-12-20T23:07:16.000Z</span>
</code></pre>

<h3>Conditions: an array of objects</h3>
<p><strong>Bucket:</strong> I set this as a global environment variable and then interpolate the value into a string.</p>
<pre><code>
  <span class="str">'bucket':</span><span class="str">'</span><span class="plain">#{</span><span class="str">ENV['S3_BUCKET_NAME']</span><span class="plain">}</span><span>'</span>
</code></pre>
<p><strong>'starts-with', '$key':</strong> the SecureRandom key that you generated.</p>
<pre><code>
  <span class="str">'starts-with', '$key', '#{@key}'</span>
</code></pre>
<p><strong>acl:</strong> Access control list. This value determines how the object will be accessed. In our case, we want the object to public readable.</p>
<pre><code>
  <span class="str">'acl': 'public-read'</span>
</code></pre>
<p><strong>'starts-with', '$Content-Type'</strong>: this value tells s3 what type of file to expect. In our case, only images. Even though we specify 'image/jpeg' here, AWS will in fact allow .gif and .png files to be uploaded by specifying the content type this way.</p>
<pre><code>
  <span class="str">'starts-with', '$Content-Type', 'image/jpeg'</span>
</code></pre>
<p><strong>'content-length-range':</strong> Since we don't don't the size of the files we pass in a range. In this case, between 0 and 10mb.</p>
<pre><code>
  <span class="str">'content-length-range', 0, 10485760</span>
</code></pre>
<p>We then daisy-chain the ruby gsub method and replace all linefeeds and carriage returns with nothing.</p>
<pre><code>
  <span class="plain">gsub(</span><span class="str">/\n|\r/</span><span class="plain">, </span><span class="str">''</span><span class="plain">)</span>
</code></pre>

<p class="lead">And finally, the <strong>signature</strong> is the final piece of the signKey. This is generated by hashing your policy with your secret access key (assigned to your IAM identity) and then Base64 encoding the hash. You must implement HMAC SHA1 as your hashing strategy.</p>
<pre><code>
  <span class="cla">Base64</span><span class="plain">.encode64(</span><span class="cla">OpenSSL</span><span class="plain">::</span><span class="cla">HMAC</span><span class="plain">.digest(</span><span class="cla">OpenSSL</span><span class="plain">::</span><span class="cla">Digest</span><span class="plain">.</span><span class="method">new</span><span class="plain">(</span><span class="str">'sha1'</span><span class="plain">), </span><span class="sym">ENV</span><span class="plain">[</span><span class="str">'AWS_SECRET_ACCESS_KEY'</span><span class="plain">], </span><span class="var">@policy</span><span class="plain">)).gsub(</span><span class="cla">/\n| |\r/</span><span class="plain">, </span><span class="str">''</span><span class="plain">)</span>
</code></pre>

<p class="lead">Put it all together, and it looks like this:</p>
<pre><code>
  <span class="method">class</span> <span class="str">Amazon</span>
    <span class="method">def</span> <span class="str">self.get_s3_upload_key</span>
      <span class="plain">@</span><span class="var">key</span> <span class='str'>=</span> <span class="str">"uploads/</span><span class='plain'>#{</span><span class='str'>SecureRandom.uuid</span><span class='plain'>}</span><span class='str'>"</span>
      <span class='plain'>@</span><span class="var">policy</span> <span class='str'>=</span> <span class="cla">Base64</span><span class="plain">.encode64(</span>
        <span class='str'>"{'expiration': '</span><span class='plain'>#{</span><span class='str'>30.minutes.from_now.utc.strftime</span><span class='plain'>(</span><span class='str'>'%Y-%m-%dT%H:%M:%S.000Z'</span><span class='plain'>)}</span><span class='str'>',</span>
        <span class='str'>'conditions': [
          {'bucket': '</span><span class='plain'>#{</span><span class='str'>ENV['S3_BUCKET_NAME']</span><span class='plain'>}</span><span class='str'>'},
          ['starts-with', '$key', '</span><span class='plain'>#{@</span><span class='str'>key</span><span class='plain'>}</span><span class='str'>'],
          {'acl': 'public-read'},
          ['starts-with', '$Content-Type', 'image/jpeg'],
          ['content-length-range', 0, 10485760],
        ]}"</span><span class='plain'>).gsub(</span><span class='str'>/\n|\r/</span><span class='plain'>, </span><span class='str'>''</span><span class='plain'>)</span>
      <span class='plain'>@</span><span class='var'>signature</span><span class='str'> = </span><span class="cla">Base64</span><span class="plain">.encode64(</span><span class="cla">OpenSSL</span><span class="plain">::</span><span class="cla">HMAC</span><span class="plain">.digest(</span><span class="cla">OpenSSL</span><span class="plain">::</span><span class="cla">Digest</span><span class="plain">.</span><span class="method">new</span><span class="plain">(</span><span class="str">'sha1'</span><span class="plain">), </span><span class="sym">ENV</span><span class="plain">[</span><span class="str">'AWS_SECRET_ACCESS_KEY'</span><span class="plain">], </span><span class="var">@policy</span><span class="plain">)).gsub(</span><span class="cla">/\n| |\r/</span><span class="plain">, </span><span class="str">''</span><span class="plain">)</span>
      <span class="sym">return </span><span class='plain'>{</span><span class='sym'>access_key</span><span class='plain'>:</span> <span class='var'>ENV</span><span class='plain'>[</span><span class='str'>'AWS_ACCESS_KEY_ID'</span><span class='plain'>]</span><span class='plain'>, </span><span class='sym'>key</span><span class='plain'>:</span> <span class='plain'>@</span><span class='var'>key</span><span class='plain'>,</span> <span class='sym'>policy</span><span class='plain'>:</span> <span class='plain'>@</span><span class='var'>policy</span><span class='plain'>,</span> <span class='sym'>signature</span><span class='plain'>:</span> <span class='plain'>@</span><span class='var'>signature</span><span class='plain'>}</span>
    end
  end
</code></pre>
<p class="lead">And finally, the Rails controller that calls the model:</p>
<pre><code>
  <span class='method'>class</span> <span class='str'>AmazonController</span> <span class='plain'>&lt; ApplicationController</span>
    <span class='method'>def</span> <span class='str'>sign_key</span>
      <span class='plain'>response</span> <span class='str'>=</span> <span class='cla'>Amazon</span><span class='plain'>.get_s3_upload_key</span>
      <span class='plain'>render</span> <span class='sym'>json</span><span class='plain'>: response,</span> <span class='sym'>status</span><span class='plain'>:</span> <span class='sym'>200</span>
    <span class='method'>end</span>
  <span class='method'>end</span>
</code></pre>


<!-- 
——————————————————————————————————————————
      END AMAZON SIGNKEY POST
——————————————————————————————————————————
 -->


 <!-- 
——————————————————————————————————————————
      Switzerland post
——————————————————————————————————————————
-->
<p class='lead'>My dream vacation—I dubbed it the Sound of Music Tour '013. We toured the German alps, and made our way through the Swiss Alps with Eurail passes. We flew into Frankfurt, and spent the first week with family in Garmisch-Partenkirchen. There we hiked in the Partnach Gorge, went up the Zugspitze, and generally had an effing blast. From Garmisch, we took a train to Zurich for a night. After Zurich, we climbed up into the Berner Oberland into Mürren. We hiked and toured the Lauterbrünnen Valley. We ended our trip in Bern. I took photos everywhere.</p>

<!-- END SWISS POST -->


<p class='lead'>Morbi leo risus, porta ac consectetur ac, vestibulum at eros. Cras mattis consectetur purus sit amet fermentum. Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Vestibulum id ligula porta felis euismod semper. Praesent commodo cursus magna, vel scelerisque nisl consectetur et.</p>
<p class='lead'>Praesent commodo cursus magna, vel scelerisque nisl consectetur et. Donec id elit non mi porta gravida at eget metus. Curabitur blandit tempus porttitor. Nullam id dolor id nibh ultricies vehicula ut id elit.</p>
<p class='lead'>Cum sociis natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Donec sed odio dui. Nullam id dolor id nibh ultricies vehicula ut id elit. Nullam id dolor id nibh ultricies vehicula ut id elit. Donec sed odio dui. Cras mattis consectetur purus sit amet fermentum. Morbi leo risus, porta ac consectetur ac, vestibulum at eros.</p>
<p class='lead'>Donec id elit non mi porta gravida at eget metus. Donec sed odio dui. Nullam id dolor id nibh ultricies vehicula ut id elit. Donec sed odio dui. Vivamus sagittis lacus vel augue laoreet rutrum faucibus dolor auctor. Nullam id dolor id nibh ultricies vehicula ut id elit. Cras mattis consectetur purus sit amet fermentum.</p>
<pre class="">
  require 'rails_helper'
  require 'spec_helper'

  describe 'Images API Endpoint' do

    before(:all) do
      Post.delete_all
      Image.delete_all
      User.delete_all
      @user = User.create({
        first_name:"Jason",
        last_name:"Wharff",
        username:"jasonwharff",
        role:"admin",
        email:"fishermanswharff@mac.com",
        password_digest:"$2a$10$qA2kdO7MOlWkAUIUQWhNtuzlIZScAs69QrTHxn13BM9i6jUUuLbfS",
        token:"9cbaf8c82925426c869ecfc4b610c8a6",
      })
      @post = FactoryGirl.create(:post)
      @images = FactoryGirl.create_list(:image,25)
      @images.map { |image| @post.images << image }
    end

    describe '#index' do
      it 'should return all of the images' do
        expect(@images.length).to eq 25
      end
    end

    describe '#create' do
      it 'should add the image to the post''s images ' do
        post "/posts/#{@post.id}/images",
          { image: 
            { url: 'https://s3.amazonaws.com/dubya-blog-bucket/uploads/eb00f33c-b80e-4e72-ada4-36bdc24f551b',
              post_id: @post.id
             }
          }.to_json,
          { 'Accept' => Mime::JSON, 'Content-Type' => Mime::JSON.to_s, 'HTTP_AUTHORIZATION' => '9cbaf8c82925426c869ecfc4b610c8a6' }
        expect(response).to be_success
        expect(response.content_type).to be Mime::JSON
      end
    end

    describe '#update' do

    end

    describe '#destroy' do
      it 'should  delete the image out of the post' do
        image = @images.last
        delete "/posts/#{@post.id}/images/#{image.id}"
        expect(response.status).to eq 202
        postcontent = json(response.body)
        expect(postcontent['images'].length).to eq 24
      end
    end
  end
</pre>


<pre><code>
</code></pre>

